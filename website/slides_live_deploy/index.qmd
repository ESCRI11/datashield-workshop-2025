---
title: "Opal Live Deployment"
subtitle: "Dick Postma and Xavier EscribÃ  Montagut"
format: 
  revealjs:
    theme: default
    slide-number: true
    chalkboard: true
    preview-links: auto
    css: styles.css
---

## Overview

**Goal**: Take your local DataSHIELD deployment public with production-grade security

**Why go live?**

- ğŸŒ **Global access** - colleagues can connect from anywhere
- ğŸ”’ **Real SSL certificates** - no more security warnings
- ğŸš€ **Production-ready** - proper reverse proxy and hardening
- ğŸ¤ **Collaboration** - share with research partners worldwide
- ğŸ“Š **Real research** - ready for actual data and studies

---

## Two Paths to Production

**ğŸ›ï¸ Path 1: Research Center IT (Recommended)**

- You: Deploy locally on institutional server
- IT: Handles DNS, SSL, firewalls, security
- Best for: Most research scenarios


**â˜ï¸ Path 2: Full Cloud Deployment (What we'll show)**

- You: Handle everything from server to SSL
- Best for: Complete control, learning, cloud deployments
- We'll demo this path for full understanding!

---

## Architecture Transformation

```
Local (HTTP only)          â†’    Production (HTTPS + Security)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â†’    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser:8080    â”‚        â†’    â”‚ Browser â†’ your-domain.com   â”‚
â”‚       â†“         â”‚        â†’    â”‚       â†“                     â”‚
â”‚ Opal (direct)   â”‚        â†’    â”‚ Nginx (SSL + Security)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â†’    â”‚       â†“                     â”‚
                           â†’    â”‚ Opal (protected)            â”‚
                           â†’    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**New components**: Nginx reverse proxy + Certbot for SSL

---

## Prerequisites

**Domain & DNS**

- Registered domain + DNS A/AAAA to your server's public IP

**Server & Network**

- Linux server (Ubuntu 22.04/24.04 recommended)
- Ports 80 and 443 open to internet
- Docker + Docker Compose installed

**Verification**: `nslookup your-domain.com` should return your server IP

---

## File Structure

```
datashield-live/
â”œâ”€â”€ .env                    # ğŸ”§ YOU EDIT: Domain + password
â”œâ”€â”€ docker-compose.yml      # ğŸ“‹ PROVIDED: All services
â”œâ”€â”€ nginx-template.conf     # ğŸ“‹ PROVIDED: SSL config
â”œâ”€â”€ nginx-http-only.conf    # ğŸ“‹ PROVIDED: Temp config
â”œâ”€â”€ get-certs.sh            # ğŸš€ PROVIDED: SSL setup
â””â”€â”€ renew-certs.sh          # ğŸ”„ PROVIDED: Auto renewal
```

<br>

**You only edit ONE file** (`.env`) - everything else is ready!

---

## Step 1: Environment Configuration

**Only file you need to edit:**

```bash
# DNS Configuration - CHANGE THIS!
DNS_DOMAIN=datashield.myresearch.org

# Opal Configuration - CHANGE THIS!
OPAL_ADMINISTRATOR_PASSWORD=SuperSecurePassword123!
```

<br>

âš ï¸ **Critical**: Ensure DNS points to your server before proceeding!

ğŸ” **Security**: Use a strong password - this protects your entire DataSHIELD server

---

## Step 2: The Magic Three-Step Deploy

```bash
# ğŸš€ Step 1: Start DataSHIELD services
docker-compose up -d mongo rock opal
sleep 30  # Let services initialize

# ğŸ”’ Step 2: Get SSL certificates
./get-certs.sh

# ğŸ”„ Step 3: Start Nginx with SSL
docker-compose stop nginx
docker-compose rm -f nginx  
docker-compose up -d nginx

echo "ğŸ‰ Production deployment complete!"
```

**That's it!** Three commands and you're live.

---

## Step 3: Verification & Testing

**Web Access**

- Open `https://your-domain.com`
- Look for ğŸ”’ green lock icon
- Login: `administrator` + your password

---

## Step 3: R Connection Test

**Connect from R**

```r
library(DSI)
library(DSOpal) 
library(dsBaseClient)

b <- DSI::newDSLoginBuilder()
b$append(server = "production",
         url = "https://your-domain.com",
         user = "administrator", 
         password = "your-password")

conns <- DSI::datashield.login(b$build())
ds.ls()
```

---

## Maintenance & Monitoring

**Certificate Renewal** (automatic)
```bash
# Test renewal
docker compose run --rm certbot renew --dry-run

# Cron job for auto-renewal
0 3 * * * cd /path/to/deployment && \
  docker compose run --rm certbot renew && \
  docker compose exec nginx nginx -s reload
```

**Health Monitoring**

- Monitor logs: `docker-compose logs`
- Service status: `docker-compose ps`

---

## Troubleshooting

**DNS Issues**

- Verify: `nslookup your-domain.com` returns server IP
- DNS propagation can take up to 48 hours

**SSL Certificate Problems**

- Ensure ports 80/443 are open

**Connection Failures**

- Verify all services running: `docker-compose ps`
- Check firewall/security groups allow 80/443

---

## Summary

âœ… **Achieved**: Production Opal deployment

ğŸš€ **New capabilities**:

- HTTPS access with SSL certificates
- "Normal" domain name
- Automatic certificate management

ğŸ¯ **Ready for**: Real-world research collaboration and data analysis!
